---

- name: Update APT package cache
  apt: update_cache=yes cache_valid_time=3600

- name: Upgrading distribution
  apt: upgrade=yes
  register: upgrade_distribution

- name: Rebooting Rpi
  shell: sleep 2 && shutdown -r now "Ansible updates triggered"
  async: 1
  poll: 0
  ignore_errors: true
  when: upgrade_distribution|changed

- name: Waiting for server to come back
  local_action: wait_for host={{ inventory_hostname }} state=started delay=30 timeout=300
  become: false
  when: upgrade_distribution|changed

- name: Updating hostname
  hostname: name={{ rpi_host_name }}
  register: hostname_change

- name: Update /etc/hosts (1/2)
  lineinfile: dest=/etc/hosts regexp='^127\.0\.1\.1' line='127.0.0.1	localhost	{{ rpi_host_name }}' owner=root group=root mode=0644 backup=yes

- name: Update /etc/hosts (2/2)
  lineinfile: dest=/etc/hosts regexp='^::1' line='::1		localhost ip6-localhost ip6-loopback	{{ rpi_host_name }}' owner=root group=root mode=0644

- name: Reload facts
  setup:
  when: hostname_change.changed

- name: Setup locale
  lineinfile: dest=/etc/locale.gen regexp="^#{{item}}" line="{{item}}"
  with_items: "{{ rpi_locale }}"
  register: update_locale

- name: Generate locales
  command: locale-gen
  when: update_locale|changed

- name: Install required packages
  apt: state=installed pkg={{ item }}
  with_items: "{{ required_packages }}"

- name: Add new group for shared items (downloads and other roles)
  group: state=present name={{ rpi_shared_group }}

- name: Create new Rpi owner
  user: name={{ rpi_user_name }} groups={{ rpi_shared_group }} password={{ rpi_user_password | password_hash('sha512') }} shell=/bin/zsh append=yes

- name: Add user to sudoers
  lineinfile: dest=/etc/sudoers regexp="{{ rpi_user_name }} ALL" line="{{ rpi_user_name }} ALL=(ALL) ALL" state=present
