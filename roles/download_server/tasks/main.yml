---

- name: Install aria2 package
  apt: state=installed pkg=aria2

- name: Add new user for download server
  user: name={{ ds_user_name }} groups={{ rpi_shared_group }} comment="Aria2 Download Server" state=present append=yes

- name: Make downloads directory
  file: path={{ ds_downloads_directory }} state=directory mode=0770

- name: Make configuration directory
  file: path=/home/{{ ds_user_name }}/.aria2 state=directory owner={{ ds_user_name }}

- name: Copy aria2 configuration
  template: src=aria2/aria2.conf.j2 dest=/home/{{ ds_user_name }}/.aria2/aria2.conf owner={{ ds_user_name }} mode=0600

- name: Generate a certificate and private key for RPC communications
  command: openssl req -out {{ aria2_cert_path }} -new -newkey rsa:4096 -nodes -keyout {{ aria2_private_key_path }} -subj "/"
  when: aria2_rpc_encrypted
  notify: Restart aria2

- name: Updates private key permissions
  file: path={{ aria2_private_key_path }} owner={{ ds_user_name }} group={{ rpi_shared_group }} mode=0700
  when: aria2_rpc_encrypted

- name: Updates certificate permissions
  file: path={{ aria2_cert_path }} owner={{ ds_user_name }} group={{ rpi_shared_group }}
  when: aria2_rpc_encrypted

- name: Install aria2 service
  template: src=aria2/aria2.service dest=/etc/systemd/system/aria2.service owner=root group=root mode=0644
  notify: Restart aria2

- name: Enable aria2 daemon on boot
  service: name=aria2 enabled=true state=started
